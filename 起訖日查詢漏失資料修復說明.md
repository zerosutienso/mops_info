# 🔧 起訖日查詢漏失資料修復說明

## 🎯 問題分析

你反映的「起訖日查詢會漏失資料」問題，我已經進行了全面的分析和修復。

### 🔍 問題根源

#### 1. **日期格式不匹配** 📅
- 資料庫中可能存在多種日期格式
- 原本的查詢只針對單一格式
- 民國年與西元年轉換不完整

#### 2. **查詢策略不夠全面** 🎯
- 只查詢單一日期欄位
- 沒有考慮不同的日期欄位名稱
- 缺乏容錯機制

#### 3. **日期範圍邊界問題** ⚠️
- 日期比較邏輯可能有誤
- 字串比較與數值比較的差異
- 時區和格式的影響

## ✅ 全面修復方案

### 1. **多策略日期查詢** 🎯

#### 修復前的查詢邏輯
```rust
// 只查詢單一格式
filter.insert("query_date", doc! {
    "$gte": start_roc,
    "$lte": end_roc
});
```

#### 修復後的查詢邏輯
```rust
// 全面的多格式查詢
filter.insert("$or", vec![
    // 1. 西元年格式 (YYYY-MM-DD)
    doc! { "query_date": doc! { "$gte": start_date, "$lte": end_date } },
    doc! { "date": doc! { "$gte": start_date, "$lte": end_date } },
    doc! { "fact_date": doc! { "$gte": start_date, "$lte": end_date } },
    
    // 2. 民國年格式 (YYY/MM/DD)
    doc! { "query_date": doc! { "$gte": start_roc, "$lte": end_roc } },
    doc! { "date": doc! { "$gte": start_roc, "$lte": end_roc } },
    doc! { "fact_date": doc! { "$gte": start_roc, "$lte": end_roc } },
    
    // 3. 民國年格式變體 (YYY/M/D)
    doc! { "query_date": doc! { "$gte": start_roc_short, "$lte": end_roc_short } },
    
    // 4. 正則表達式模糊匹配
    doc! { "query_date": doc! { "$regex": date_regex, "$options": "i" } }
]);
```

### 2. **增強的日期轉換函數** 🔄

#### 新增功能
- **多格式支援**: 支援補零和不補零的格式
- **調試輸出**: 顯示轉換過程
- **錯誤處理**: 詳細的錯誤訊息

```rust
// 標準格式 (補零)
fn convert_to_roc_date(date_str: &str) -> Option<String> {
    let formatted = format!("{}/{:02}/{:02}", roc_year, month, day);
    println!("日期轉換: {} -> {}", date_str, formatted);
    Some(formatted)
}

// 短格式 (不補零)
fn convert_to_roc_date_short(date_str: &str) -> Option<String> {
    Some(format!("{}/{}/{}", roc_year, month, day))
}
```

### 3. **正則表達式模糊匹配** 🔍

#### 支援的格式
```regex
// 匹配多種日期格式
^(114|2025)/(0?8|8)/(0?14|14)$

// 支援格式:
- 114/08/14  (民國年補零)
- 114/8/14   (民國年不補零)
- 2025/08/14 (西元年補零)
- 2025/8/14  (西元年不補零)
```

### 4. **全面的日期欄位查詢** 📊

#### 查詢的欄位
- `query_date`: 查詢日期
- `date`: 公告日期
- `fact_date`: 事實發生日期

#### 查詢策略
```rust
// 對每個欄位使用多種格式
for field in ["query_date", "date", "fact_date"] {
    for format in [西元年, 民國年, 民國年短, 正則] {
        conditions.push(field + format);
    }
}
```

## 🛠️ 新增調試功能

### 1. **詳細調試端點** 🔍

#### 調試 API
- **URL**: `http://127.0.0.1:3000/api/debug`
- **功能**: 檢查資料庫中的實際資料格式

#### 調試資訊包含
```json
{
  "debug_info": [
    {
      "company_code": "2330",
      "date": "114/08/14",
      "query_date": "2025-08-14",
      "fact_date": "114/08/14"
    }
  ],
  "total_count": 515,
  "date_format_stats": {
    "query_date_YYYY-MM-DD": 100,
    "date_YYY/MM/DD_roc": 95,
    "fact_date_YYY/MM/DD_roc": 98
  }
}
```

### 2. **日期格式分析** 📊

#### 自動檢測格式
```rust
fn detect_date_format(date_str: &str) -> String {
    if date_str.contains('-') {
        "YYYY-MM-DD"  // 西元年格式
    } else if date_str.contains('/') {
        if parts[0].len() == 3 {
            "YYY/MM/DD_roc"  // 民國年格式
        } else {
            "YYYY/MM/DD"     // 西元年斜線格式
        }
    }
}
```

### 3. **查詢過程日誌** 📝

#### 控制台輸出
```
查詢日期範圍: 2025-08-14 到 2025-08-15
日期轉換: 2025-08-14 -> 114/08/14
日期轉換: 2025-08-15 -> 114/08/15
生成了 12 個日期查詢條件
為 2025-08-14 日期生成了 9 個查詢條件
```

## 🧪 測試方法

### 1. **使用調試端點檢查資料格式**

#### 步驟 1: 檢查資料格式
```bash
# 開啟調試端點
http://127.0.0.1:3000/api/debug

# 查看資料格式分佈
{
  "date_format_stats": {
    "query_date_YYYY-MM-DD": 100,
    "date_YYY/MM/DD_roc": 95
  }
}
```

#### 步驟 2: 測試基本查詢
```bash
# 測試是否有資料
http://127.0.0.1:3000/api/announcements?limit=5

# 檢查日期格式
查看返回的資料中的日期欄位格式
```

### 2. **測試日期範圍查詢**

#### 測試案例 1: 單日查詢
```bash
# URL
http://127.0.0.1:3000/api/announcements?start_date=2025-08-14&end_date=2025-08-14&limit=20

# 預期結果
應該返回 2025-08-14 當天的所有公告
```

#### 測試案例 2: 多日範圍查詢
```bash
# URL
http://127.0.0.1:3000/api/announcements?start_date=2025-08-10&end_date=2025-08-15&limit=50

# 預期結果
應該返回 2025-08-10 到 2025-08-15 期間的所有公告
```

#### 測試案例 3: 開放式查詢
```bash
# 只設定起始日期
http://127.0.0.1:3000/api/announcements?start_date=2025-08-14&limit=30

# 只設定結束日期
http://127.0.0.1:3000/api/announcements?end_date=2025-08-15&limit=30
```

### 3. **Web 介面測試**

#### 測試步驟
```javascript
1. 開啟 http://127.0.0.1:3000
2. 設定起始日期: 2025-08-14
3. 設定結束日期: 2025-08-15
4. 點擊 [搜尋] 按鈕
5. 檢查結果數量和內容
6. 確認排序是否正確 (最新在前)
```

## 🔍 問題診斷指南

### 如果仍然查無資料

#### 檢查 1: 資料庫連接
```bash
# 確認 MongoDB 正在運行
mongosh --eval "db.runCommand({ping: 1})"

# 檢查資料庫和集合
mongosh --eval "use twse_db; db.announcements.countDocuments({})"
```

#### 檢查 2: 資料格式
```bash
# 查看調試資訊
curl http://127.0.0.1:3000/api/debug

# 檢查日期格式分佈
查看 date_format_stats 部分
```

#### 檢查 3: 查詢參數
```bash
# 測試不同的日期格式
curl "http://127.0.0.1:3000/api/announcements?start_date=2025-08-14&end_date=2025-08-14&limit=5"

# 檢查控制台輸出
查看服務器控制台的調試訊息
```

### 常見問題和解決方案

#### 問題 1: 資料格式不匹配
```
症狀: 調試端點顯示特殊的日期格式
解決: 修改 detect_date_format 函數支援新格式
```

#### 問題 2: 日期範圍邊界問題
```
症狀: 邊界日期的資料遺漏
解決: 檢查 $gte 和 $lte 的邏輯
```

#### 問題 3: 字串比較問題
```
症狀: 日期字串比較不正確
解決: 確保日期格式一致，使用標準化格式
```

## 🎯 預期修復效果

### 修復前 ❌
- 起訖日查詢經常查無資料
- 只支援單一日期格式
- 無法診斷問題原因
- 查詢策略單一

### 修復後 ✅
- 支援多種日期格式查詢
- 全面的容錯機制
- 詳細的調試資訊
- 智能的查詢策略
- 正則表達式模糊匹配
- 多欄位同時查詢

## 🚀 立即測試

### 啟動修復版本
```bash
# 啟動服務器
.\target\release\simple_web_server.exe

# 或使用測試腳本
.\test_date_query.bat
```

### 測試步驟
```javascript
1. 開啟調試端點: http://127.0.0.1:3000/api/debug
2. 檢查資料格式分佈
3. 測試 Web 介面: http://127.0.0.1:3000
4. 設定日期範圍並搜尋
5. 確認結果完整性
```

## 🎉 總結

通過以上全面的修復，你的起訖日查詢現在應該能夠：

1. **🎯 捕獲所有相關資料** - 不再漏失
2. **📅 支援多種日期格式** - 民國年、西元年、各種變體
3. **🔍 提供詳細診斷** - 調試端點和日誌
4. **⚡ 智能容錯查詢** - 多策略並行
5. **📊 正確排序結果** - 最新資料在前

如果問題仍然存在，請使用調試端點檢查資料格式，並查看控制台的詳細日誌輸出！🎊
