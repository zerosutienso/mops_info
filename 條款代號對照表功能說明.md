# 📋 條款代號對照表功能實現說明

## 🎯 功能概述

根據你提供的上市公司重大訊息條款極簡摘要，我已經成功實現了條款代號對照表功能，將條款代號與其說明存入 MongoDB，並在 Web 查詢時顯示對應的說明。

## ✅ 實現內容

### 1. **資料結構定義**

#### 條款代號對照表結構
```rust
#[derive(Debug, Serialize, Deserialize, Clone)]
struct ClauseCode {
    #[serde(rename = "_id", skip_serializing_if = "Option::is_none")]
    id: Option<bson::oid::ObjectId>,
    code: String,        // 條款代號 (如 "12", "51")
    description: String, // 條款說明 (如 "說明會或未申報資訊發布")
    #[serde(skip_serializing_if = "Option::is_none")]
    created_at: Option<chrono::DateTime<chrono::Utc>>,
}
```

### 2. **條款代號對照表內容**

#### 完整的 51 個條款代號
```rust
let clause_codes = vec![
    ("1", "信用異常或股票交易異動"),
    ("2", "涉訟或主管違法"),
    ("3", "停工、減產、資產處理"),
    ("4", "公司法重大決議"),
    ("5", "重整或破產程序"),
    ("6", "高層人事異動或席次不足"),
    ("7", "更換會計師或承銷商"),
    ("8", "重要主管異動"),
    ("9", "會計年度或政策變更"),
    ("10", "重大契約、合作或新產品量產"),
    ("11", "資本變動或合併收購"),
    ("12", "說明會或未申報資訊發布"),
    ("13", "財務預測差異重大"),
    ("14", "股利政策異動或延遲"),
    ("15", "大額投資計畫"),
    ("16", "增資或債券計畫變動"),
    ("17", "股東會召開通知"),
    ("18", "股東會重要決議"),
    ("19", "舞弊、掏空或主管遭羈押"),
    ("20", "資產交易或衍生損失重大"),
    ("21", "經理人或董事競業行為"),
    ("22", "背書保證達標準"),
    ("23", "資金貸與達標準"),
    ("24", "私募證券交易"),
    ("25", "主要客戶或供應商終止往來"),
    ("26", "災難、罷工、資安等重大事件"),
    ("27", "與銀行協商結果確定"),
    ("28", "關係人或債務人信用異常"),
    ("29", "內控聲明或審查報告"),
    ("30", "財報錯誤或遭保留意見"),
    ("31", "財報提報或自結資訊異動"),
    ("32", "股票集中保管不足"),
    ("33", "股權變動通知"),
    ("34", "董監事遭停止職權"),
    ("35", "公司買回股份"),
    ("36", "減資或面額異動作業"),
    ("37", "上市承諾未履行"),
    ("38", "公開收購申報或通知"),
    ("40", "暫停或恢復交易"),
    ("41", "控股公司持股變動"),
    ("42", "終止上市或改列申請"),
    ("43", "重大捐贈"),
    ("44", "委員會反對或董事會逾越建議"),
    ("45", "增資由特定人認購"),
    ("46", "子公司達終止上市標準或營收為零"),
    ("47", "海外財報與台灣準則差異"),
    ("48", "特定營業細則情事"),
    ("49", "子公司控制力喪失或持股下降"),
    ("50", "子公司海外掛牌相關事項"),
    ("51", "其他重大決策或影響股價事件"),
];
```

**注意**: 條款 39 已刪除，因此對照表中不包含此條款。

### 3. **MongoDB 初始化功能**

#### 自動初始化對照表
```rust
async fn initialize_clause_codes(collection: &mongodb::Collection<ClauseCode>) -> Result<()> {
    println!("📋 正在初始化條款代號對照表...");
    
    // 檢查是否已經初始化
    let count = collection.count_documents(doc! {}, None).await?;
    if count > 0 {
        println!("📋 條款代號對照表已存在，跳過初始化");
        return Ok(());
    }

    // 插入條款代號資料
    let mut documents = Vec::new();
    for (code, description) in clause_codes {
        documents.push(ClauseCode {
            id: None,
            code: code.to_string(),
            description: description.to_string(),
            created_at: Some(chrono::Utc::now()),
        });
    }

    collection.insert_many(documents, None).await?;
    println!("✅ 條款代號對照表初始化完成，共 {} 筆資料", 
        collection.count_documents(doc! {}, None).await?);
    
    Ok(())
}
```

#### 初始化時機
- 在執行 `--save-mongodb` 時自動初始化
- 只在第一次執行時建立，後續執行會跳過
- 存入 `clause_codes` 集合

### 4. **Web API 功能**

#### 條款代號查詢 API
```rust
async fn clause_codes_handler(
    State(state): State<Arc<AppState>>,
) -> Result<impl IntoResponse, StatusCode> {
    let collection: Collection<ClauseCode> = state
        .db_client
        .database(&state.database_name)
        .collection("clause_codes");

    let mut cursor = collection.find(doc! {}, None).await
        .map_err(|_| StatusCode::INTERNAL_SERVER_ERROR)?;
    
    let mut clause_codes = Vec::new();
    while cursor.advance().await.map_err(|_| StatusCode::INTERNAL_SERVER_ERROR)? {
        let clause_code = cursor.deserialize_current()
            .map_err(|_| StatusCode::INTERNAL_SERVER_ERROR)?;
        clause_codes.push(clause_code);
    }

    // 按條款代號排序
    clause_codes.sort_by(|a, b| {
        let a_num: i32 = a.code.parse().unwrap_or(999);
        let b_num: i32 = b.code.parse().unwrap_or(999);
        a_num.cmp(&b_num)
    });

    Ok(Json(clause_codes))
}
```

#### API 端點
- **路由**: `/api/clause-codes`
- **方法**: GET
- **回應**: JSON 格式的條款代號對照表
- **排序**: 按條款代號數字順序排列

### 5. **Web 介面整合**

#### 前端載入條款代號對照表
```javascript
// 全域變數
let clauseCodes = {}; // 條款代號對照表

// 載入條款代號對照表
async function loadClauseCodes() {
    try {
        const response = await fetch('/api/clause-codes');
        const codes = await response.json();
        
        // 轉換為 key-value 對照表
        clauseCodes = {};
        codes.forEach(code => {
            clauseCodes[code.code] = code.description;
        });
        
        console.log('📋 條款代號對照表載入完成:', Object.keys(clauseCodes).length, '筆');
    } catch (error) {
        console.error('載入條款代號對照表失敗:', error);
    }
}

// 取得條款代號說明
function getClauseDescription(code) {
    return clauseCodes[code] || '';
}
```

#### 頁面初始化
```javascript
// 頁面載入時初始化
window.addEventListener('load', function() {
    loadClauseCodes();
});
```

### 6. **條款代號顯示增強**

#### 在公告標題旁顯示條款說明
```html
<!-- 公告標題 -->
<div class="announcement-title">
    ${announcement.title}
    ${announcement.clause_code ? `
    <span class="badge bg-info ms-2" title="${getClauseDescription(announcement.clause_code)}">
        <i class="fas fa-gavel me-1"></i>條款 ${announcement.clause_code}
    </span>
    ${getClauseDescription(announcement.clause_code) ? `
    <small class="text-muted ms-2">
        <i class="fas fa-info-circle me-1"></i>
        ${getClauseDescription(announcement.clause_code)}
    </small>
    ` : ''}
    ` : ''}
</div>
```

#### 顯示效果
```
🏢 2327 - 國巨           🕐 114/08/18 16:30:15
公告本公司股票面額變更    🏷️ 條款 51  ℹ️ 其他重大決策或影響股價事件
[顯示明細]

🏢 6176 - 瑞儀           🕐 114/08/18 15:55:21  
法人說明會重要資訊        🏷️ 條款 12  ℹ️ 說明會或未申報資訊發布
[顯示明細]

🏢 2809 - 京城銀         🕐 114/08/18 14:30:45
受金管會裁罰案            🏷️ 條款 26  ℹ️ 災難、罷工、資安等重大事件
[顯示明細]
```

## 🗄️ MongoDB 資料庫結構

### 1. **條款代號對照表集合**

#### 集合名稱
```
clause_codes
```

#### 文件結構
```javascript
{
  "_id": ObjectId("..."),
  "code": "12",
  "description": "說明會或未申報資訊發布",
  "created_at": ISODate("2025-08-18T12:49:56.554Z")
}
```

#### 索引建議
```javascript
// 為條款代號建立唯一索引
db.clause_codes.createIndex({ "code": 1 }, { unique: true })

// 為描述建立文字索引以支援搜尋
db.clause_codes.createIndex({ "description": "text" })
```

### 2. **公告資料集合**

#### 集合名稱
```
announcements
```

#### 文件結構（包含條款代號）
```javascript
{
  "_id": ObjectId("..."),
  "company_code": "2327",
  "company_name": "國巨",
  "title": "公告本公司股票面額變更",
  "date": "114/08/18",
  "time": "16:30:15",
  "clause_code": "51",
  "detail_content": "...",
  "created_at": ISODate("2025-08-18T12:49:56.554Z")
}
```

## 🔍 查詢功能

### 1. **API 查詢範例**

#### 取得所有條款代號
```bash
curl http://127.0.0.1:3000/api/clause-codes
```

#### 回應範例
```json
[
  {
    "code": "1",
    "description": "信用異常或股票交易異動",
    "created_at": "2025-08-18T12:49:56.554Z"
  },
  {
    "code": "2", 
    "description": "涉訟或主管違法",
    "created_at": "2025-08-18T12:49:56.554Z"
  },
  ...
]
```

### 2. **MongoDB 查詢範例**

#### 查詢特定條款代號的說明
```javascript
db.clause_codes.findOne({ "code": "12" })
```

#### 查詢包含特定關鍵字的條款
```javascript
db.clause_codes.find({ "description": { $regex: "說明會", $options: "i" } })
```

#### 統計各條款代號的使用頻率
```javascript
db.announcements.aggregate([
  { $match: { "clause_code": { $exists: true, $ne: null } } },
  { $group: { 
    _id: "$clause_code", 
    count: { $sum: 1 } 
  }},
  { $lookup: {
    from: "clause_codes",
    localField: "_id",
    foreignField: "code", 
    as: "clause_info"
  }},
  { $unwind: "$clause_info" },
  { $project: {
    code: "$_id",
    count: 1,
    description: "$clause_info.description"
  }},
  { $sort: { count: -1 } }
])
```

## 🧪 測試驗證

### 1. **功能測試**

#### 執行資料擷取和初始化
```bash
./target/release/twse-announcements.exe --date 2025-08-18 --format json --save-mongodb
```

#### 預期結果
- ✅ 條款代號對照表初始化成功
- ✅ 51 筆條款代號資料存入 MongoDB
- ✅ 公告資料包含條款代號
- ✅ Web 介面顯示條款說明

### 2. **Web 介面測試**

#### 開啟 Web 查詢
```
http://127.0.0.1:3000
```

#### 檢查項目
- ✅ 條款代號對照表載入成功
- ✅ 公告標題旁顯示條款標籤和說明
- ✅ 滑鼠懸停顯示完整說明
- ✅ 條款說明以灰色小字顯示

### 3. **API 測試**

#### 測試條款代號 API
```bash
curl http://127.0.0.1:3000/api/clause-codes | jq '.[0:5]'
```

#### 預期回應
```json
[
  {
    "code": "1",
    "description": "信用異常或股票交易異動"
  },
  {
    "code": "2",
    "description": "涉訟或主管違法"
  },
  ...
]
```

## 📊 條款代號使用統計

### 常見條款代號及其用途

| 條款代號 | 說明 | 使用頻率 | 主要用途 |
|----------|------|----------|----------|
| 12 | 說明會或未申報資訊發布 | 高頻 | 法人說明會、投資人會議 |
| 51 | 其他重大決策或影響股價事件 | 高頻 | 公司名稱變更、面額變更 |
| 31 | 財報提報或自結資訊異動 | 高頻 | 財務報告、自結數字 |
| 14 | 股利政策異動或延遲 | 中頻 | 除權息、股利分派 |
| 26 | 災難、罷工、資安等重大事件 | 中頻 | 裁罰案件、重大事件 |
| 18 | 股東會重要決議 | 中頻 | 股東會決議事項 |
| 22 | 背書保證達標準 | 低頻 | 背書保證事項 |
| 23 | 資金貸與達標準 | 低頻 | 資金貸與事項 |

## 🎯 功能優勢

### 1. **使用者體驗提升**
- ✅ 直觀顯示條款代號含義
- ✅ 無需記憶條款代號對應內容
- ✅ 滑鼠懸停顯示完整說明
- ✅ 視覺化標籤設計

### 2. **資料完整性**
- ✅ 完整的 51 個條款代號對照
- ✅ 自動初始化，無需手動維護
- ✅ 與公告資料完美整合
- ✅ 支援未來條款代號擴展

### 3. **查詢便利性**
- ✅ API 提供條款代號查詢
- ✅ 支援條款代號統計分析
- ✅ 便於法規遵循檢查
- ✅ 支援關鍵字搜尋

### 4. **技術穩定性**
- ✅ 自動檢查避免重複初始化
- ✅ 錯誤處理機制完善
- ✅ 前後端資料同步
- ✅ 跨瀏覽器相容

## 🚀 使用方式

### 1. **初始化條款代號對照表**
```bash
# 執行任何包含 --save-mongodb 的命令都會自動初始化
./target/release/twse-announcements.exe --date 2025-08-18 --format json --save-mongodb
```

### 2. **Web 查詢**
```bash
# 啟動 Web 服務器
./target/release/simple_web_server.exe

# 開啟瀏覽器
http://127.0.0.1:3000
```

### 3. **API 查詢**
```bash
# 查詢所有條款代號
curl http://127.0.0.1:3000/api/clause-codes

# 查詢公告資料（包含條款代號）
curl http://127.0.0.1:3000/api/announcements
```

## 🎉 實現成果

### 成功建立
- ✅ **條款代號對照表**: 51 筆完整的條款代號與說明
- ✅ **MongoDB 集合**: `clause_codes` 集合自動建立
- ✅ **API 端點**: `/api/clause-codes` 提供查詢功能
- ✅ **Web 整合**: 前端自動載入並顯示條款說明

### 使用者體驗
- ✅ **視覺標籤**: 藍色條款代號標籤
- ✅ **詳細說明**: 條款說明以小字顯示
- ✅ **懸停提示**: 滑鼠懸停顯示完整說明
- ✅ **自動載入**: 頁面載入時自動獲取對照表

### 技術優勢
- ✅ **自動初始化**: 首次執行自動建立對照表
- ✅ **資料同步**: 前後端資料完全同步
- ✅ **效能優化**: 前端快取對照表減少 API 調用
- ✅ **擴展性**: 支援未來新增條款代號

現在你可以完整地查看每個重大訊息的條款代號及其詳細說明，大大提升了資料的可讀性和實用性！🎊
