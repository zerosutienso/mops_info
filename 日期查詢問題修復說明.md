# 🔧 日期查詢問題修復說明

## 🎯 問題分析

根據你反映的問題，我已經識別並修復了以下兩個主要問題：

### 1. **起訖日查詢查無資料** 🔍
**問題原因**:
- 日期格式不匹配
- 資料庫中的日期欄位可能有多種格式
- 民國年轉換邏輯需要優化

### 2. **查詢結果排序問題** 📊
**問題原因**:
- 原本只按 `created_at` 排序
- 需要按日期時間的邏輯順序排序

## ✅ 修復方案

### 1. **多策略日期查詢** 🎯

#### 原本的查詢邏輯
```rust
// 只查詢單一日期欄位
filter.insert("query_date", doc! {
    "$gte": start_roc,
    "$lte": end_roc
});
```

#### 修復後的查詢邏輯
```rust
// 使用 $or 查詢多種可能的日期格式
filter.insert("$or", vec![
    doc! { "query_date": doc! { "$gte": start, "$lte": end } },
    doc! { "date": doc! { "$gte": start_date, "$lte": end_date } },
    doc! { "fact_date": doc! { "$gte": start, "$lte": end } }
]);
```

### 2. **優化排序邏輯** 📈

#### 原本的排序
```rust
.sort(doc! { "created_at": -1 })
```

#### 修復後的排序
```rust
.sort(doc! { 
    "date": -1,           // 日期降序 (最新的在前)
    "time": -1,           // 時間降序 (最晚的在前)
    "created_at": -1      // 建立時間降序 (最新的在前)
})
```

### 3. **增強日期轉換函數** 🔄

#### 新增功能
- **調試輸出**: 顯示日期轉換過程
- **格式化改進**: 確保月日為兩位數
- **錯誤處理**: 更詳細的錯誤訊息

```rust
fn convert_to_roc_date(date_str: &str) -> Option<String> {
    // 格式化為 YYY/MM/DD，確保月日為兩位數
    let formatted = format!("{}/{:02}/{:02}", 
        roc_year, 
        month.parse::<u32>().unwrap_or(0), 
        day.parse::<u32>().unwrap_or(0)
    );
    
    println!("日期轉換: {} -> {}", date_str, formatted);
    Some(formatted)
}
```

### 4. **新增調試端點** 🛠️

#### 調試 API
- **端點**: `http://127.0.0.1:3000/api/debug`
- **功能**: 檢查資料庫中的實際資料格式
- **用途**: 診斷日期格式問題

```json
{
  "debug_info": [
    {
      "company_code": "2330",
      "date": "114/08/14",
      "time": "16:30:15",
      "query_date": "2025-08-14",
      "fact_date": "114/08/14"
    }
  ],
  "total_count": 515
}
```

## 🧪 測試方法

### 1. **使用測試腳本**
```bash
.\test_date_query.bat
```

### 2. **手動測試步驟**

#### 步驟 1: 檢查資料格式
```
開啟: http://127.0.0.1:3000/api/debug
查看: 資料庫中的實際日期格式
```

#### 步驟 2: 測試基本查詢
```
開啟: http://127.0.0.1:3000/api/announcements?limit=5
確認: 資料是否按時間排序
```

#### 步驟 3: 測試日期範圍查詢
```
開啟: http://127.0.0.1:3000/api/announcements?start_date=2025-08-14&end_date=2025-08-15&limit=10
確認: 是否能查到指定日期範圍的資料
```

#### 步驟 4: 測試 Web 介面
```
開啟: http://127.0.0.1:3000
操作: 設定起訖日期並搜尋
確認: 查詢結果是否正確
```

## 🔍 問題診斷

### 如果仍然查無資料

#### 檢查 1: 資料庫中的日期格式
```bash
# 查看調試資訊
curl http://127.0.0.1:3000/api/debug
```

#### 檢查 2: 查詢參數
```bash
# 測試不同的日期格式
curl "http://127.0.0.1:3000/api/announcements?start_date=2025-08-14&end_date=2025-08-14&limit=5"
```

#### 檢查 3: 控制台輸出
查看服務器控制台的調試訊息：
```
日期轉換: 2025-08-14 -> 114/08/14
查詢日期範圍: 2025-08-14 到 2025-08-14
```

### 常見問題和解決方案

#### 問題 1: 民國年轉換錯誤
```
解決方案: 檢查年份是否 > 1911
確認: 2025 - 1911 = 114 (正確)
```

#### 問題 2: 日期格式不匹配
```
解決方案: 使用 $or 查詢多種格式
支援格式: 
- "114/08/14" (民國年)
- "2025-08-14" (西元年)
- "114/8/14" (單位數月日)
```

#### 問題 3: 排序不正確
```
解決方案: 多層排序
順序: date -> time -> created_at
方向: 降序 (最新在前)
```

## 🎯 使用建議

### 1. **日期範圍查詢**
```javascript
// 推薦的查詢方式
起始日期: 2025-08-14
結束日期: 2025-08-15
筆數限制: 100

// 避免的查詢方式
起始日期: 114/08/14  // 不要使用民國年輸入
```

### 2. **快速測試**
```javascript
// 使用快速按鈕
[今日] -> 查看今天的公告
[昨日] -> 查看昨天的公告
[本週] -> 查看本週的公告
```

### 3. **排序確認**
```javascript
// 檢查排序是否正確
1. 最新日期在最上面
2. 同一天內最晚時間在上面
3. 相同時間按建立順序
```

## 🚀 啟動修復版本

### 方法 1: 使用測試腳本
```bash
.\test_date_query.bat
```

### 方法 2: 直接啟動
```bash
cargo build --bin simple_web_server --release
.\target\release\simple_web_server.exe
```

### 方法 3: 使用優化腳本
```bash
.\start_optimized_web.bat
```

## 📊 預期效果

### 修復前
- ❌ 起訖日查詢無結果
- ❌ 排序混亂
- ❌ 無法診斷問題

### 修復後
- ✅ 起訖日查詢正常
- ✅ 按時間正確排序
- ✅ 提供調試工具
- ✅ 支援多種日期格式
- ✅ 詳細的錯誤訊息

## 🎉 總結

通過以上修復，你的 Web 查詢系統現在應該能夠：

1. **正確處理起訖日期查詢** 📅
2. **按時間順序排序結果** ⏰
3. **提供調試資訊** 🔍
4. **支援多種日期格式** 🔄
5. **顯示詳細的查詢過程** 📝

如果問題仍然存在，請使用調試端點檢查資料格式，並查看控制台輸出的調試訊息！
