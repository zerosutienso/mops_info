# 📅 事實發生日擷取功能實現說明

## 🎯 功能概述

根據你的要求，我已經成功實現了從原始 HTML 資料中擷取 `name='h07' value='20250815'` 這類事實發生日的功能，並將原始 HTML 資料完整保存。

## ✅ 實現內容

### 1. **資料結構擴展**

#### 新增事實發生日欄位
```rust
#[derive(Debug, Serialize, Deserialize, Clone)]
struct Announcement {
    // ... 原有欄位 ...
    #[serde(skip_serializing_if = "Option::is_none")]
    pub fact_occurrence_date: Option<String>, // 新增事實發生日欄位 (從 h07 擷取)
    #[serde(skip_serializing_if = "Option::is_none")]
    pub raw_html: Option<String>, // 新增原始 HTML 資料欄位
    // ... 其他欄位 ...
}
```

### 2. **HTML 解析邏輯**

#### 擷取 h07 欄位的事實發生日
```rust
fn extract_detail_info(&self, row: &scraper::ElementRef, input_selector: &Selector) -> (Option<String>, Option<String>, Option<String>, Option<String>, Option<String>, String) {
    let mut fact_occurrence_date = None;
    
    // 保存原始 HTML
    let raw_html = row.html();

    // 在這一行中尋找隱藏的 input 欄位
    for input in row.select(input_selector) {
        if let Some(name) = input.value().attr("name") {
            if let Some(value) = input.value().attr("value") {
                match name {
                    name if name.ends_with("7") => { // h07, h17, h27 等包含事實發生日
                        if !value.trim().is_empty() {
                            // 將 YYYYMMDD 格式轉換為 YYYY-MM-DD 格式
                            let formatted_date = format_fact_occurrence_date(value);
                            fact_occurrence_date = Some(formatted_date.clone());
                            println!("📅 擷取事實發生日: {} = {} -> {}", name, value, formatted_date);
                        }
                    }
                    // ... 其他欄位處理 ...
                }
            }
        }
    }

    (detail_content, announcement_type, fact_date, clause_code, fact_occurrence_date, raw_html)
}
```

### 3. **日期格式化功能**

#### YYYYMMDD 轉 YYYY-MM-DD
```rust
// 格式化事實發生日 (YYYYMMDD -> YYYY-MM-DD)
fn format_fact_occurrence_date(date_str: &str) -> String {
    if date_str.len() == 8 && date_str.chars().all(|c| c.is_ascii_digit()) {
        // YYYYMMDD 格式
        let year = &date_str[0..4];
        let month = &date_str[4..6];
        let day = &date_str[6..8];
        format!("{}-{}-{}", year, month, day)
    } else {
        // 如果不是標準格式，直接返回原始值
        date_str.to_string()
    }
}
```

#### 格式化範例
```
輸入: "20250708" -> 輸出: "2025-07-08"
輸入: "20250529" -> 輸出: "2025-05-29"
輸入: "20250724" -> 輸出: "2025-07-24"
```

### 4. **原始 HTML 保存**

#### 完整 HTML 內容保存
```rust
// 保存原始 HTML
let raw_html = row.html();

// 存入資料結構
let announcement = Announcement {
    // ... 其他欄位 ...
    fact_occurrence_date,
    raw_html: Some(raw_html),
    // ... 其他欄位 ...
};
```

#### HTML 檔案保存
```rust
// 在 --save-html 參數時保存原始 HTML 檔案
if args.save_html {
    let html_filename = format!("twse_announcements_{}.html", date_str);
    std::fs::write(&html_filename, &response_text)?;
    println!("✅ HTML 檔案已儲存: {}", html_filename);
}
```

### 5. **Web 介面顯示**

#### 事實發生日標籤顯示
```javascript
// 在公告標題旁顯示事實發生日
${announcement.fact_occurrence_date ? `
<span class="badge bg-warning ms-2">
    <i class="fas fa-calendar-alt me-1"></i>事實發生日 ${announcement.fact_occurrence_date}
</span>
` : ''}
```

#### 顯示效果
```
🏢 2327 - 國巨           🕐 114/08/18 16:30:15
公告本公司股票面額變更    🏷️ 條款 51  📅 事實發生日 2025-07-08
[顯示明細]

🏢 2762 - 世界健身-KY    🕐 114/08/18 15:55:21  
公司名稱變更             🏷️ 條款 51  📅 事實發生日 2025-05-29
[顯示明細]
```

### 6. **CSV 匯出功能**

#### 包含事實發生日的 CSV
```javascript
function generateCSV(announcements) {
    const headers = ['公司代號', '公司名稱', '標題', '日期', '時間', '條款代號', '事實發生日', '詳細內容'];
    const csvRows = [headers.join(',')];

    announcements.forEach(announcement => {
        const row = [
            `"${announcement.company_code}"`,
            `"${announcement.company_name}"`,
            `"${announcement.title.replace(/"/g, '""')}"`,
            `"${announcement.date}"`,
            `"${announcement.time}"`,
            `"${announcement.clause_code || ''}"`,
            `"${announcement.fact_occurrence_date || ''}"`, // 新增事實發生日欄位
            `"${(announcement.detail_content || '').replace(/"/g, '""')}"`
        ];
        csvRows.push(row.join(','));
    });

    return '\uFEFF' + csvRows.join('\n');
}
```

## 🔍 擷取範例

### 1. **HTML 輸入範例**
```html
<input type="hidden" name="h07" value="20250708">
<input type="hidden" name="h17" value="20250529">
<input type="hidden" name="h27" value="20250724">
<input type="hidden" name="h37" value="20250714">
```

### 2. **擷取輸出範例**
```
📅 擷取事實發生日: h07 = 20250708 -> 2025-07-08
📅 擷取事實發生日: h17 = 20250529 -> 2025-05-29
📅 擷取事實發生日: h27 = 20250724 -> 2025-07-24
📅 擷取事實發生日: h37 = 20250714 -> 2025-07-14
```

### 3. **JSON 輸出範例**
```json
{
  "company_code": "2327",
  "company_name": "國巨",
  "title": "公告本公司股票面額變更",
  "date": "114/08/18",
  "time": "16:30:15",
  "fact_occurrence_date": "2025-07-08",
  "clause_code": "51",
  "raw_html": "<tr class=\"even\">...</tr>",
  "created_at": "2025-08-18T14:07:15.519149500Z"
}
```

## 🗄️ MongoDB 資料庫

### 1. **文件結構**
```javascript
{
  "_id": ObjectId("..."),
  "company_code": "2327",
  "company_name": "國巨",
  "title": "公告本公司股票面額變更",
  "date": "114/08/18",
  "time": "16:30:15",
  "fact_occurrence_date": "2025-07-08", // 新增欄位
  "clause_code": "51",
  "raw_html": "<tr class=\"even\">...</tr>", // 新增欄位
  "created_at": ISODate("2025-08-18T14:07:15.519Z")
}
```

### 2. **查詢範例**

#### 查詢特定事實發生日的公告
```javascript
db.announcements.find({ "fact_occurrence_date": "2025-07-08" })
```

#### 查詢事實發生日範圍
```javascript
db.announcements.find({ 
  "fact_occurrence_date": { 
    $gte: "2025-07-01", 
    $lte: "2025-07-31" 
  } 
})
```

#### 統計各事實發生日的公告數量
```javascript
db.announcements.aggregate([
  { $match: { "fact_occurrence_date": { $exists: true, $ne: null } } },
  { $group: { 
    _id: "$fact_occurrence_date", 
    count: { $sum: 1 } 
  }},
  { $sort: { _id: 1 } }
])
```

## 📁 檔案保存

### 1. **原始 HTML 檔案**
```
檔案名稱: twse_announcements_20250818.html
內容: 完整的原始 HTML 回應
用途: 保留原始資料以供後續分析或除錯
```

### 2. **JSON 檔案**
```
檔案名稱: twse_announcements_20250818.json
內容: 解析後的結構化資料
包含: 事實發生日、原始 HTML、條款代號等
```

### 3. **文字檔案**
```
檔案名稱: twse_announcements_20250818.txt
內容: 人類可讀的格式化輸出
用途: 快速瀏覽和檢查資料
```

## 🧪 測試驗證

### 1. **功能測試**

#### 執行擷取命令
```bash
./target/release/twse-announcements.exe --date 2025-08-18 --format json --save-mongodb --save-html
```

#### 預期結果
- ✅ 成功擷取事實發生日
- ✅ 原始 HTML 檔案保存
- ✅ JSON 包含新欄位
- ✅ MongoDB 資料更新

### 2. **資料驗證**

#### 檢查事實發生日格式
```
輸入格式: YYYYMMDD (如 20250708)
輸出格式: YYYY-MM-DD (如 2025-07-08)
```

#### 檢查原始 HTML 保存
```
每筆資料的 raw_html 欄位包含完整的 <tr>...</tr> HTML 內容
```

### 3. **Web 介面測試**

#### 開啟 Web 查詢
```
http://127.0.0.1:3000
```

#### 檢查項目
- ✅ 事實發生日標籤顯示
- ✅ 黃色標籤樣式
- ✅ 日曆圖示
- ✅ CSV 匯出包含事實發生日

## 🎯 功能優勢

### 1. **資料完整性**
- ✅ 完整保存原始 HTML 資料
- ✅ 結構化擷取事實發生日
- ✅ 標準化日期格式
- ✅ 與其他欄位完美整合

### 2. **使用者體驗**
- ✅ 視覺化事實發生日標籤
- ✅ 直觀的日期顯示格式
- ✅ CSV 匯出包含完整資訊
- ✅ 支援日期範圍查詢

### 3. **技術穩定性**
- ✅ 自動日期格式轉換
- ✅ 錯誤處理機制
- ✅ 原始資料備份
- ✅ 向後相容性

### 4. **分析便利性**
- ✅ 支援事實發生日統計
- ✅ 便於時間序列分析
- ✅ 原始 HTML 可供深度分析
- ✅ 標準化資料格式

## 🚀 使用方式

### 1. **擷取資料並保存 HTML**
```bash
./target/release/twse-announcements.exe --date 2025-08-18 --format json --save-mongodb --save-html
```

### 2. **Web 查詢**
```bash
# 啟動 Web 服務器
./target/release/simple_web_server.exe

# 開啟瀏覽器
http://127.0.0.1:3000
```

### 3. **API 查詢**
```bash
# 查詢包含事實發生日的公告
curl "http://127.0.0.1:3000/api/announcements?limit=10" | jq '.[].fact_occurrence_date'
```

## 🎉 實現成果

### 成功建立
- ✅ **事實發生日擷取**: 從 h07 等欄位自動擷取
- ✅ **日期格式化**: YYYYMMDD -> YYYY-MM-DD
- ✅ **原始 HTML 保存**: 完整保存每筆資料的原始 HTML
- ✅ **檔案保存**: HTML、JSON、TXT 三種格式

### 資料完整性
- ✅ **結構化資料**: 事實發生日存入 JSON 和 MongoDB
- ✅ **原始資料**: 完整的 HTML 內容保存
- ✅ **格式標準化**: 統一的日期格式
- ✅ **向後相容**: 不影響現有功能

### 使用者體驗
- ✅ **視覺標籤**: 黃色事實發生日標籤
- ✅ **CSV 匯出**: 包含事實發生日欄位
- ✅ **API 支援**: 程式化查詢介面
- ✅ **查詢便利**: 支援日期範圍查詢

🎊 **事實發生日擷取功能已完全實現！現在每個重大訊息都會顯示對應的事實發生日，並且原始 HTML 資料完整保存，大大提升了資料的完整性和分析價值！**
